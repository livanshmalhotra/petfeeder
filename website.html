<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PetFeeder - Smart Pet Feeding System</title>
  <style>
    :root {
      --primary-color: #6C63FF;
      --secondary-color: #4CAF50;
      --dark-bg: #1a1a2e;
      --darker-bg: #16213e;
      --card-bg: #0f3460;
      --text-color: #e9ecef;
      --accent-color: #FF6B6B;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #1a1a2e;
      color: #e9ecef;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #16213e;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: var(--darker-bg);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .nav-header {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
    }

    .nav-header a {
      color: var(--text-color);
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 5px;
      transition: all 0.3s ease;
      background: var(--darker-bg);
    }

    .nav-header a:hover {
      background: var(--primary-color);
      transform: translateY(-2px);
    }

    h1 {
      color: #6C63FF;
      text-align: center;
      margin-bottom: 20px;
    }

    .subtitle {
      color: var(--text-color);
      font-size: 1.2em;
      opacity: 0.8;
    }

    .pet-section {
      background-color: #0f3460;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .pet-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .pet-icon {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .pet-name {
      font-size: 1.8em;
      color: var(--primary-color);
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .control-group {
      background-color: #16213e;
      padding: 20px;
      border-radius: 8px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #e9ecef;
    }

    select, input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #1a1a2e;
      border: 2px solid #6C63FF;
      border-radius: 5px;
      color: #e9ecef;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    button {
      background-color: #6C63FF;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #FF6B6B;
    }

    .status {
      background-color: #16213e;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      margin-top: 20px;
    }

    .clock {
      font-size: 2em;
      text-align: center;
      margin: 20px 0;
      color: #6C63FF;
      font-weight: bold;
    }

    .pet-image {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 15px;
      margin: 20px auto;
      display: block;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 2em;
      }
    }

    .section {
      margin-bottom: 40px;
      padding: 20px;
      background: var(--darker-bg);
      border-radius: 15px;
    }

    .section h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .history-container {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .history-table th,
    .history-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--darker-bg);
    }

    .history-table th {
      background-color: var(--darker-bg);
      color: var(--primary-color);
      font-weight: bold;
    }

    .history-table tr:hover {
      background-color: var(--darker-bg);
    }

    .status-success {
      color: #4CAF50;
    }

    .status-error {
      color: #FF6B6B;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>PetFeeder</h1>
      <p class="subtitle">Smart Pet Feeding System</p>
      <div class="nav-header">
        <a href="#register">Register</a>
        <a href="#login">Login</a>
        <a href="#feed-now">Feed Right Now</a>
        <a href="#schedule">Schedule Timings</a>
        <a href="#history">Feeding History</a>
      </div>
    </header>

    <div id="feed-now" class="section">
      <h2>Feed Right Now</h2>
      <div class="pet-section">
        <div class="pet-header">
          <div class="pet-icon">üêæ</div>
          <div class="control-group" style="margin: 0; flex-grow: 1;">
            <label for="petName">Select Pet Name:</label>
            <select id="petName" onchange="updatePetName()">
              <option value="Bruno">Bruno</option>
              <option value="Luna">Luna</option>
              <option value="Max">Max</option>
              <option value="Bella">Bella</option>
              <option value="Charlie">Charlie</option>
              <option value="Lucy">Lucy</option>
              <option value="Cooper">Cooper</option>
              <option value="Daisy">Daisy</option>
            </select>
          </div>
        </div>
        
        <div class="clock" id="clock">00:00:00</div>
        
        <div class="control-panel">
          <div class="control-group">
            <label for="animal">Select Pet Type:</label>
            <select id="animal" onchange="updatePetImage()">
              <option value="dog">Dog</option>
              <option value="cat">Cat</option>
              <option value="bird">Bird</option>
              <option value="fish">Fish</option>
              <option value="hamster">Hamster</option>
            </select>

            <label for="grams">Amount (grams):</label>
            <select id="grams">
              <option value="10">10g</option>
              <option value="20">20g</option>
              <option value="30">30g</option>
              <option value="40">40g</option>
              <option value="50">50g</option>
              <option value="60">60g</option>
              <option value="70">70g</option>
              <option value="80">80g</option>
              <option value="90">90g</option>
              <option value="100">100g</option>
            </select>

            <button onclick="triggerFeed()">Feed Now</button>
          </div>
        </div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div id="schedule" class="section">
      <h2>Schedule Timings</h2>
      <div class="control-group">
        <label for="hh">Hour (0-23):</label>
        <input type="number" id="hh" min="0" max="23" value="0">

        <label for="mm">Minute (0-59):</label>
        <input type="number" id="mm" min="0" max="59" value="0">

        <label for="ss">Second (0-59):</label>
        <input type="number" id="ss" min="0" max="59" value="0">

        <button onclick="scheduleFeed()">Schedule Feed</button>
      </div>
    </div>

    <div id="history" class="section">
      <h2>Feeding History</h2>
      <div class="history-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Pet Name</th>
              <th>Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <!-- History entries will be added here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const ESP32_IP = "http://192.168.72.162"; // Replace with your ESP32 IP
    const statusDiv = document.getElementById("status");
    const datetimeDiv = document.getElementById("clock");

    // Function to add entry to history
    function addToHistory(petName, grams, status, isSuccess) {
      const historyTableBody = document.getElementById('historyTableBody');
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${timeString}</td>
        <td>${petName}</td>
        <td>${grams}g</td>
        <td class="${isSuccess ? 'status-success' : 'status-error'}">${status}</td>
      `;
      
      // Add new row at the top of the table
      historyTableBody.insertBefore(row, historyTableBody.firstChild);
      
      // Keep only last 10 entries
      while (historyTableBody.children.length > 10) {
        historyTableBody.removeChild(historyTableBody.lastChild);
      }
    }

    function getPetName() {
      const selectValue = document.getElementById("animal").value;
      return selectValue;
    }

    function triggerFeed() {
      const grams = document.getElementById("grams").value;
      const petName = getPetName();

      // Feed immediately
      statusDiv.textContent = `Feeding ${grams}g to ${petName} now...`;
      statusDiv.style.color = "blue";
      
      // Log the request for debugging
      console.log("Sending feed command:", {
        grams: grams,
        pet: petName,
        url: `${ESP32_IP}/feed?grams=${grams}&pet=${encodeURIComponent(petName)}`
      });

      sendFeedCommand(grams, petName, petName);
    }

    function scheduleFeed() {
      const hh = parseInt(document.getElementById("hh").value, 10);
      const mm = parseInt(document.getElementById("mm").value, 10);
      const ss = parseInt(document.getElementById("ss").value, 10);
      const grams = document.getElementById("grams").value;
      const petName = getPetName();

      if (isNaN(hh) || isNaN(mm) || isNaN(ss) || hh < 0 || hh > 23 || mm < 0 || mm > 59 || ss < 0 || ss > 59) {
        statusDiv.textContent = "Please enter valid time values (HH:MM:SS).";
        statusDiv.style.color = "red";
        return;
      }

      // Get current time
      const now = new Date();
      const targetTime = new Date();
      targetTime.setHours(hh, mm, ss, 0);
      
      // If target time is earlier than current time, schedule for next day
      if (targetTime < now) {
        targetTime.setDate(targetTime.getDate() + 1);
      }
      
      const delay = targetTime - now;
      
      statusDiv.textContent = `Scheduled to feed ${grams}g to ${petName} at ${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
      statusDiv.style.color = "blue";

      // Schedule the feed
      setTimeout(() => {
        sendFeedCommand(grams, petName, petName);
      }, delay);
    }

    function sendFeedCommand(grams, petName, animal) {
      // Add timeout to the fetch request
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);

      // Show initial status
      statusDiv.textContent = `Feeding ${grams}g to ${petName}...`;
      statusDiv.style.color = "blue";

      fetch(`${ESP32_IP}/feed?grams=${grams}&pet=${encodeURIComponent(petName)}&animal=${animal}`, {
        signal: controller.signal
      })
        .then(response => {
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(message => {
          console.log("Feed command response:", message);
          
          // Wait for motor to return to idle position
          setTimeout(() => {
            statusDiv.textContent = "FEEDED";
            statusDiv.style.color = "green";
            statusDiv.style.fontWeight = "bold";
            statusDiv.style.fontSize = "1.2em";
            addToHistory(petName, grams, "Success", true);
          }, grams * 100 + 500); // Wait for feeding duration plus 500ms for motor to return
        })
        .catch(error => {
          clearTimeout(timeoutId);
          console.error("Feed command error:", error);
          
          let statusMessage = "Error";
          if (error.name === 'AbortError') {
            statusMessage = "Timeout";
            statusDiv.textContent = "Feed command timed out. Please check if the feeder is connected.";
            statusDiv.style.color = "red";
          } else if (error.message.includes("Failed to fetch")) {
            statusMessage = "Connection Failed";
            statusDiv.textContent = "Cannot connect to feeder. Please check the connection.";
            statusDiv.style.color = "red";
          } else {
            statusMessage = "Error";
            statusDiv.textContent = `Feeding ${grams}g to ${petName} (${animal})...`;
            statusDiv.style.color = "blue";
          }
          
          addToHistory(petName, grams, statusMessage, false);
        });
    }

    function updateTime() {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      datetimeDiv.textContent = `${date} ‚Äî ${time}`;
    }

    function updatePetName() {
      const petName = document.getElementById('petName').value;
    }

    function updatePetImage() {
      const petType = document.getElementById('animal').value;
    }

    // Update clock
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString();
      document.getElementById('clock').textContent = time;
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>